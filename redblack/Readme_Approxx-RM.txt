This version was adopted form BAR and converted to OpenMP compatibale code.
